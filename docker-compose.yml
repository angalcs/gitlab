services:
  web:
    build:
      context: "."
    container_name: gitlab
    environment:
      GITLAB_OMNIBUS_CONFIG: |
          gitlab_rails['time_zone'] = "Asia/Tehran"
          gitlab_rails['backup_keep_time'] = 14515200
          gitlab_rails['smtp_pool'] = false
          gitlab_rails['gitlab_shell_ssh_port'] = 2224
        
          external_url 'http://gitlab.parasite-resume.ir:8929'
          nginx['listen_port'] = 8929
          nginx['listen_https'] = false
          
          registry_external_url "http://registry.parasite-resume.ir:8929"
          registry_nginx['listen_port'] = 8929
          registry_nginx['listen_https'] = false
                
          puma['worker_processes'] = 0
          puma['per_worker_max_memory_mb'] = 1024
        
          sidekiq['concurrency'] = 1
          sidekiq['max_concurrency'] = 2
        
          grafana['enable'] = false
          prometheus_monitoring['enable'] = false
          alertmanager['enable'] = false
        
          postgresql['shared_buffers'] = "256MB"
          postgresql['auto_restart_on_version_change'] = false
    hostname: gitlab.parasite-resume.ir
    image: "gitlab/gitlab-ee:latest"
    ports:
      - "8929:8929"
      - "2224:22"
    restart: always
    shm_size: 256m
    volumes:
      - "/srv/gitlab/config:/etc/gitlab"
      - "/srv/gitlab/logs:/var/log/gitlab"
      - "/srv/gitlab/data:/var/opt/gitlab"
version: "3.6"
